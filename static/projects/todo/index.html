<!DOCTYPE html>
<html>
<head>
	<title>Todos</title>

	<style type="text/css">
		body {
			font-size: 125%;
			margin: 1em auto;
			max-width: 40em;
			width: 88%;
		}

		form {
			margin-bottom: 2em;
		}

		label {
			display: block;
			width: 100%;
		}

		[type="checkbox"] {
			margin-right: 0.5em;
		}

		.todos {
			list-style: none;
			margin: 0 0 1em;
			padding: 0;
		}

		.todos li {
			margin-bottom: 0.5em;
		}

		/**
		 * @bugfix Prevent webkit from removing list semantics
		 * 1. Add a non-breaking space
		 * 2. Make sure it doesn't mess up the DOM flow
		 */
		.todos li:before {
			content: "\200B"; /* 1 */
			position: absolute; /* 2 */
		}

		.todo-completed {
			text-decoration: line-through;
		}

		.todos button,
		.lists button {
			background: transparent;
			border: 0;
			cursor: pointer;
			padding: 0;
		}
	</style>
</head>
<body>

	<p><a href="/#work-on-fun-projects">&larr; Back to the Vanilla JS Academy</a></p>

	<h1>Todos</h1>

	<div id="app"></div>

	<script src="https://cdn.jsdelivr.net/gh/cferdinandi/reef@4/dist/reef.min.js"></script>
	<script>
		//
		// Variables
		//

		// Save the localStorage ID to a variable for easier configuration later
		var storageID = 'todosEdit';


		//
		// Methods
		//

		/**
		 * Get the URL parameters
		 * source: https://css-tricks.com/snippets/javascript/get-url-variables/
		 * @param  {String} url The URL
		 * @return {Object}     The URL parameters
		 */
		var getParams = function (url) {
			var params = {};
			var parser = document.createElement('a');
			parser.href = url ? url : window.location.href;
			var query = parser.search.substring(1);
			var vars = query.split('&');
			if (vars.length < 1 || vars[0].length < 1) return params;
			for (var i = 0; i < vars.length; i++) {
				var pair = vars[i].split('=');
				params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
			}
			return params;
		};

		/**
		 * Get the template for the todo items view
		 * @param  {Object} props The todos object
		 * @return {String}       The markup string
		 */
		var getTodosTemplate = function (props) {

			// Get the specific list
			var list = props.lists[props.listID];

			// The "add todo" form
			var form =
				'<p><a href="todos-edit-completed.html">&larr; Back to Lists</a></p>' +
				'<form id="add-todos">' +
					'<label for="new-todo">' + (props.edit ? 'Edit todo' : 'What do you want to do?') + '</label>' +
					'<input type="text" id="new-todo" autofocus ' + (props.edit ? 'value="' + list.todos[props.edit].item + '"' : '') + '>' +
					'<button>' + (props.edit ? 'Edit Todo' : 'Add Todo' ) + '</button>' +
				'</form>';

			// If there are no todos, ask the user to add some
			if (list.todos.length < 1) {
				return form + '<p>You don\'t have any todos yet. Add some using the form above.</p>';
			}

			// Generate markup for todo items
			return form + '<ul class="todos">' + list.todos.map(function (todo, index) {

				var todoHTML =
					'<li>' +
						'<label for="todo-' + index + '">' +
							'<input type="checkbox" id="todo-' + index + '" data-todo="' + index + '" ' + (todo.completed ? 'checked="checked"' : '') + '>' +
							'<span ' + (todo.completed ? 'class="todo-completed"' : '') + '>' + todo.item + '</span>' +
							' <button data-edit-todo="' + index + '" aria-label="Edit ' + todo.item + '">‚úèÔ∏è</button>' +
							' <button data-delete-todo="' + index + '" aria-label="Delete ' + todo.item + '">üóë</button>' +
						'</label>' +
					'</li>';

				return todoHTML;

			}).join('') + '</ul>';

		};

		/**
		 * Get the template for the lists view
		 * @param  {Object} props The todos object
		 * @return {String}       The markup string
		 */
		var getListsTemplate = function (props) {

			// The "add todo" form
			var form =
				'<form id="add-list">' +
					'<label for="new-list">' + (props.edit ? 'Edit todo list' : 'Create a new todo list') + '</label>' +
					'<input type="text" id="new-list" autofocus ' + (props.edit ? 'value="' + props.lists[props.edit].name + '"' : '') + '>' +
					'<button>' + (props.edit ? 'Edit List' : 'Create List') + '</button>' +
				'</form>';

			// If there are no todos, ask the user to add some
			if (props.lists.length < 1) {
				return form + '<p>You don\'t have any lists yet. Add one using the form above.</p>';
			}

			// Generate markup for todo items
			return form + '<ol class="lists">' + props.lists.map(function (list, index) {

				var listHTML =
					'<li>' +
						'<a href="?list=' + index + '">' + list.name + '</a>' +
						' <button data-edit-todo="' + index + '" aria-label="Edit ' + list.name + '">‚úèÔ∏è</button>' +
						' <button data-delete-list="' + index + '" aria-label="Delete ' + list.name + '">üóë</button>' +
					'</li>';

				return listHTML;

			}).join('') + '</ol>';

		};

		/**
		 * Create a todo component
		 */
		var app = new Reef('#app', {
			data: {},
			template: function (props) {

				// If there's a list ID, show the todo list
				if (props.listID) {
					return getTodosTemplate(props);
				}

				// Otherwise, show the add lists page
				return getListsTemplate(props);

			}
		});

		/**
		 * Add a new todo item
		 * @param  {Event} event The Event object
		 */
		var addTodo = function (event) {

			// Only run for #add-todos form
			if (event.target.id !== 'add-todos') return;

			// Stop the form from reloading the page
			event.preventDefault();

			// Get the new todo input field
			var newTodo = document.querySelector('#new-todo');

			// If the #new-todo input has no value, do nothing
			if (newTodo.value.length < 1) return;

			// Get a copy of the data
			var data = app.getData();

			// Update data object
			// If an item is being edited, update
			// Otherwise, push a new item
			if (data.edit) {
				data.lists[data.listID].todos[data.edit].item = newTodo.value;
			} else {
				data.lists[data.listID].todos.push({
					item: newTodo.value,
					completed: false
				});
			}

			// Render fresh UI
			app.setData({
				lists: data.lists,
				edit: null
			});

			// Clear the field and return focus
			newTodo.value = '';
			newTodo.focus();

		};

		/**
		 * Add a new todo list
		 * @param  {Event} event The Event object
		 */
		var addList = function (event) {

			// Only run for #add-todos form
			if (event.target.id !== 'add-list') return;

			// Stop the form from reloading the page
			event.preventDefault();

			// Get the new todo input field
			var newList = document.querySelector('#new-list');

			// If the #new-todo input has no value, do nothing
			if (newList.value.length < 1) return;

			// Get a copy of the todos
			var data = app.getData();

			// Update data object
			if (data.edit) {
				data.lists[data.edit].name = newList.value;
			} else {
				data.lists.push({
					name: newList.value,
					todos: []
				});
			}

			// Render fresh UI
			app.setData({
				lists: data.lists,
				edit: null
			});

			// Clear the field and return focus
			newList.value = '';
			newList.focus();

		};

		/**
		 * Mark a todo as complete
		 * @param  {Event} event The Event object
		 */
		var completeTodo = function (event) {

			// Only run on todo items
			var todo = event.target.getAttribute('data-todo');
			if (!todo) return;

			// Get a copy of the todos
			var data = app.getData();

			// Update the todo state
			data.lists[data.listID].todos[todo].completed = event.target.checked;

			// Render a fresh UI
			app.setData({lists: data.lists});

		};

		/**
		 * Delete a todo item
		 * @param  {Event} event The Event object
		 */
		var deleteTodo = function (event) {

			// Only run on todo items
			var todo = event.target.getAttribute('data-delete-todo');
			if (!todo) return;

			// Get a copy of the todos
			var data = app.getData();

			// Delete the todo
			data.lists[data.listID].todos.splice(todo, 1);

			// Render a fresh UI
			app.setData({
				lists: data.lists,
				edit: null
			});

		};

		/**
		 * Edit a todo item
		 * @param  {Event} event The Event object
		 */
		var editTodo = function (event) {

			// Only run on todo items
			var todo = event.target.getAttribute('data-edit-todo');
			if (!todo) return;

			// Get a copy of the todos
			var data = app.getData();

			// Update the data and render a fresh UI
			app.setData({edit: todo});

		};

		/**
		 * Delete a todo list
		 * @param  {Event} event The Event object
		 */
		var deleteList = function (event) {

			// Only run on todo items
			var list = event.target.getAttribute('data-delete-list');
			if (!list) return;

			// Get a copy of the todos
			var data = app.getData();

			// Delete the todo
			data.lists.splice(list, 1);

			// Render a fresh UI
			app.setData({
				lists: data.lists,
				edit: null
			});

		};

		/**
		 * Handle form submit events
		 * @param  {Event} event The Event object
		 */
		var submitHandler = function (event) {
			addTodo(event);
			addList(event);
		};

		/**
		 * Handle click events
		 * @param  {Event} event The Event object
		 */
		var clickHandler = function (event) {
			deleteTodo(event);
			editTodo(event);
			completeTodo(event);
			deleteList(event);
		};

		/**
		 * Handle render events
		 */
		var renderHandler = function () {

			// Save todo state to localStorage
			localStorage.setItem(storageID, JSON.stringify(app.getData()));

			// If item is being edited, bring form into focus
			var editField = document.querySelector('#new-todo, #new-list');
			editField.focus();

		};

		/**
		 * Load todos into state on page load
		 */
		var loadTodos = function () {

			// Check for saved data in localStorage
			var saved = localStorage.getItem(storageID);
			var data = saved ? JSON.parse(saved) : {
				lists: []
			};

			// Remove any fields that were being edited
			data.edit = null;

			// Get the current view
			var list = getParams().list;
			data.listID = list;

			// Update the state and run an initial render
			app.setData(data);

		};


		//
		// Inits & Event Listeners
		//

		// Render the initial UI
		loadTodos();

		// Listen for form submit events
		document.addEventListener('submit', submitHandler, false);

		// Listen for click events
		document.addEventListener('click', clickHandler, false);

		// On render events, save todo items
		document.addEventListener('render', renderHandler, false);
	</script>
</body>
</html>